---
title: Data_Wrangling
author: Stefan
date: '2018-03-27'
slug: data-wrangling
categories:
  - R
tags:
  - data-wrangling
  - tidyr
---



<pre class="r"><code>require(EightyR)</code></pre>
<pre><code>## Loading required package: EightyR</code></pre>
<pre class="r"><code>load_toolbox()</code></pre>
<pre><code>## -------------------------------------------
## Loading the Analytics Toolbox libary
## -------------------------------------------
## 
## purrr
##  
## ggplot2
##  
## dplyr
##  
## tidyr
##  
## readr
##  
## lubridate
##  
## openxlsx</code></pre>
<pre class="r"><code># install.packages(&quot;openssl&quot;)
load_pkg(c(&quot;openssl&quot;))</code></pre>
<div id="why-data-wrangling" class="section level1">
<h1>Why data-wrangling</h1>
<div class="figure">
<img src="/Pictures/Creativity_painting.jpg" />

</div>
<p>Data-wrangling is absolutely essential for every data science task where we need to work with collected data.</p>
<blockquote>
<p>A recent article from the New York Times said “Data scientists, according to interviews and expert estimates, spend from 50 percent to 80 percent of their time mired in the mundane labor of collecting and preparing data, before it can be explored for useful information.”</p>
</blockquote>
<p>An excelent talk on data wrangling by Jenny Bryan:<br />
<a href="https://www.youtube.com/watch?v=4MfUCX_KpdE" class="uri">https://www.youtube.com/watch?v=4MfUCX_KpdE</a></p>
<p>It is important to highlight the following facts;<br />
- Excellent data wrangling skills will allow you to make R tools “flow” into one another.<br />
- Different functions require different input formats and so do different solutions!<br />
- The correct shape for the data will greatly simplify the stats needed to solve a problem.<br />
- For example where you would have looped over data you can now simply aggregate<br />
- For example where you would have repeated a model or visualization you now apply it over a hierarchy!<br />
- Being data fluent will allow you to come up with innovative solutions!</p>
</div>
<div id="the-basics---tabular-data-examples" class="section level1">
<h1>The basics - tabular data examples</h1>
<p>Here we will use an example of grocery store data.</p>
<div id="import-data" class="section level2">
<h2>Import data</h2>
<!-- create dummy data -->
<p>What does the data look like?:</p>
<pre class="r"><code>dummy_data &lt;- 
  readRDS(&quot;../../static/data/data-wrangling/dummy_data.rds&quot;)

dummy_data</code></pre>
<pre><code>## # A tibble: 1,000 x 10
##    customer_no      spend_month         store_counts visits_count item_sum
##    &lt;chr&gt;            &lt;dttm&gt;                     &lt;int&gt;        &lt;int&gt;    &lt;int&gt;
##  1 49ef700455a56de… 2012-12-01 00:00:00            1            1        1
##  2 210d4179edb2f92… 2012-12-01 00:00:00            1            1       NA
##  3 5067ea026ecbb08… 2012-12-01 00:00:00            1            1        6
##  4 476cfbe371456be… 2012-12-01 00:00:00            1            1        4
##  5 576c5ac92f6f5ed… 2013-01-01 00:00:00            1            1        1
##  6 e076e43495962ef… 2012-12-01 00:00:00            1            1        1
##  7 0831aff4f6e02b1… 2013-02-01 00:00:00            1            1        1
##  8 8f42509147d136a… 2012-12-01 00:00:00            1            1       NA
##  9 0f7be58a4461e2d… 2013-01-01 00:00:00            1            1        4
## 10 5d519ca4395d166… 2012-12-01 00:00:00            1            1        1
## # ... with 990 more rows, and 5 more variables: discount_sum &lt;dbl&gt;,
## #   spend_sum &lt;dbl&gt;, spend_day &lt;chr&gt;, spend_time &lt;chr&gt;, spend_type &lt;chr&gt;</code></pre>
</div>
<div id="reshaping-to-answer-a-question" class="section level2">
<h2>Reshaping to answer a question</h2>
<p><strong>The basics</strong></p>
<div id="widening" class="section level3">
<h3>Widening</h3>
<p>What if I asked you; <em>“Show me the spend in each spend_time on a customer level”</em>.</p>
<p>For a person and also for some models you will need to widen the data. By ‘widen’ we mean adding columns. Humans read better when you describe an obeservation using columns after all…</p>
<p>To widen this data we use the function <code>tidyr::spread</code></p>
<pre class="r"><code>dummy_data %&gt;% 
  select(customer_no,spend_time,spend_sum) %&gt;% 
  tidyr::spread(key = spend_time, value = spend_sum, fill = 0) </code></pre>
<pre><code>## # A tibble: 998 x 6
##    customer_no                      afternoon evening lunch morning `&lt;NA&gt;`
##    &lt;chr&gt;                                &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
##  1 001dc4f17ad2f7999c215ac147ad9a13       0       0    0       93.0      0
##  2 0020cab9597c12589249daa13a1427a8      30.8     0    0        0        0
##  3 0068525ef1d0d392ad3e97602511551a      59.9     0    0        0        0
##  4 00d75bffda7ea469a511c891a28b2df2       0       0   25.0      0        0
##  5 011aec649b655991c2835f151188c54e       0       0    0        0        0
##  6 014dd528202b032a46564f63100ced5c       0       0    0      422        0
##  7 015392d5b1b6e0b63a4ca5ce1139d4ac       0      30.0  0        0        0
##  8 01948501615939ecb5a8c49af2ab45dd       0       0    0       13.0      0
##  9 01a86d2dba1514e5a92ecb38b408bbe8      43.8     0    0        0        0
## 10 0210fe573d0e13b2cd68cabe31d3a94c       0       0    7.90     0        0
## # ... with 988 more rows</code></pre>
<p>What were the averages for these metrics?</p>
<pre class="r"><code>wide_summarised &lt;- 
  dummy_data %&gt;% 
  select(customer_no,spend_time,spend_sum) %&gt;% 
  tidyr::spread(key = spend_time, value = spend_sum, fill = 0) %&gt;% 
  summarise_if(is.numeric,mean,na.rm=TRUE)

wide_summarised</code></pre>
<pre><code>## # A tibble: 1 x 5
##   afternoon evening lunch morning `&lt;NA&gt;`
##       &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
## 1      19.8    13.5  21.1    20.9  0.271</code></pre>
<hr />
</div>
<div id="moving-back-to-long-format" class="section level3">
<h3>Moving back to long format</h3>
<p>This was very basic, but what if we wanted to do this in reverse?<br />
Of course we can do the exact opposite using <code>tidyr::gather</code></p>
<p>Let’s visualize the spend in each time category by moving back to the less natural ‘long’ format. Functions generally become more powerful the longer we can shape the data since they naturally scan vectors of columns</p>
<pre class="r"><code>wide_summarised %&gt;% 
  tidyr::gather(key = &quot;time_category&quot;, value = &quot;average_spend&quot;) %&gt;% 
  ggplot(aes( x = time_category, y = average_spend))+
  geom_bar(stat = &quot;identity&quot;)</code></pre>
<p><img src="/post/2018-03-27-data-wrangling_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>With the wide format we would need to plot each column individually but now we can do them altogether.</p>
</div>
</div>
</div>
