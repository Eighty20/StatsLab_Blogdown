---
title: "Customer matching using random forest"
author: Stefan
date: 2019-01-31
slug: random_forest_matching
categories:
  - R
tags:
  - matching
  - random_forest
  - ranger
  - proximity_matrix
---



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Measuring treatment effect in data contexts where the response was already measured without an experimental design usually requires matching to control for confounding effects.</p>
<p>Here I outline matching using random forests to improve on performance over genetic matching while maintaining reasonable matching quality</p>
</div>
<div id="why" class="section level2">
<h2>Why?</h2>
<p>In most cases the first line of attack would be matching using propensity scoring. This is easily done using a GLM logit model with a package like <code>MatchIt</code> in R.</p>
<p>Because this matches on a 1D metric only people often turn to genetic matching for its great quality of matching. This is slow however and production code can end up operating at too high a cost.</p>
</div>
<div id="how" class="section level2">
<h2>How?</h2>
<p>Random forest matching is similar to genetic algorithms because people that are matched together generally have similar traits over many different variables.</p>
<p>The way it manages this is by training a propensity model by growing decision trees. After the forest has been trained we can look at the terminal leaves in all of the trees and see how often the samples ended up in the same predictive nodes. Each node uses different variables. The average of these coocurrence matrices is the proximity matrix used for matching.</p>
</div>
<div id="comparing-run-times---random-forests-vs-genetic-matching" class="section level2">
<h2>Comparing run times - Random Forests VS Genetic matching</h2>
</div>
<div id="implementation-of-random-forest-matching" class="section level2">
<h2>Implementation of random forest matching</h2>
<p>There are many different ways to perform matching using proximity matrices. Using the base <code>randomForest</code> package you can specify hyper parameters for the model to keep it’s proximity matrices.</p>
<p>For this blog I decided to define this process using the <code>ranger</code> package instead. The main reason is that the <code>ranger</code> package is better optimized for big data and multi core processing.</p>
<div id="packages" class="section level3">
<h3>Packages</h3>
<p>To run this code you will need the following packages:</p>
<pre class="r"><code># install.packages(&quot;ranger&quot;)
library(ranger)

# install.packages(&quot;ROSE&quot;)
library(ROSE)</code></pre>
<pre><code>## Loaded ROSE 0.0-3</code></pre>
<pre class="r"><code># install.packages(&quot;devtools&quot;)
# devtools::install_github(&quot;sipemu/similarity&quot;)
library(Similarity)

library(dplyr)</code></pre>
</div>
<div id="thin-feature-space" class="section level3">
<h3>Thin feature space</h3>
<p>For this specific example our data contains 35 principal components generated by a combination of PCA and MCA models. We will fit our model on the top 5 components:</p>
<pre class="r"><code>rf_data &lt;-
  rf_data %&gt;% 
  select(1:10) %&gt;% 
  mutate(vitality = vitality %&gt;% factor)

rf_data &lt;- 
  rf_data %&gt;%
  setNames( c(&quot;customer_no&quot;,&quot;vitality&quot;,&quot;spend_month_2013_10_01&quot;,&quot;spend_month_2013_11_01&quot;,&quot;spend_month_2013_12_01&quot;,&quot;Dim_1&quot;,&quot;Dim_2&quot;, &quot;Dim_3&quot;, &quot;Dim_4&quot;, &quot;Dim_5&quot; )) 

rf_data %&gt;% glimpse</code></pre>
<pre><code>## Observations: 456,366
## Variables: 10
## $ customer_no            &lt;chr&gt; &quot;c51ce410c124a10e0db5e4b97fc2af39&quot;, &quot;28...
## $ vitality               &lt;fct&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
## $ spend_month_2013_10_01 &lt;dbl&gt; 12281.10, 0.00, 1585.58, 5314.16, 0.00,...
## $ spend_month_2013_11_01 &lt;dbl&gt; 12137.86, 0.00, 0.00, 8136.73, 286.08, ...
## $ spend_month_2013_12_01 &lt;dbl&gt; 12769.57, 541.62, 5609.84, 7454.51, 114...
## $ Dim_1                  &lt;dbl&gt; 2.206990e+00, -9.920552e-01, 3.954618e-...
## $ Dim_2                  &lt;dbl&gt; 0.34242884, -2.20506687, -0.49166710, 0...
## $ Dim_3                  &lt;dbl&gt; 0.34804986, -1.95304588, 0.03740382, -0...
## $ Dim_4                  &lt;dbl&gt; -1.696023886, -1.385098798, 1.309264779...
## $ Dim_5                  &lt;dbl&gt; -0.30175202, -0.47332798, -1.47041980, ...</code></pre>
</div>
<div id="fit-random-forest-model" class="section level3">
<h3>Fit random forest model</h3>
<p>In this example I used the ROSE sampling strategy to achieve class balance because the conversion response was heavily under represented.</p>
<p>This class imbalance will skew your GLM or random forest model outcome because the entropy or loss function won’t be easily optimized to predict the conversion cases; the false positives from all the counter factual responses wouldn’t make sense and the model will never try to guess a conversion.</p>
<p>Don’t simply copy paste this methodology! ROSE creates synthetic samples! Understand what you are matching and how you are sampling!</p>
<p>Okay here we go:</p>
<pre class="r"><code>rf_data &lt;- ROSE(vitality~., data = rf_data %&gt;% select(-customer_no), seed = 8020)$data 
rf_model &lt;- ranger(formula = vitality~. ,data = rf_data,write.forest = T,classification = T)</code></pre>
<pre><code>## Growing trees.. Progress: 7%. Estimated remaining time: 12 minutes, 15 seconds.
## Growing trees.. Progress: 17%. Estimated remaining time: 6 minutes, 39 seconds.
## Growing trees.. Progress: 26%. Estimated remaining time: 5 minutes, 34 seconds.
## Growing trees.. Progress: 32%. Estimated remaining time: 5 minutes, 9 seconds.
## Growing trees.. Progress: 40%. Estimated remaining time: 4 minutes, 33 seconds.
## Growing trees.. Progress: 48%. Estimated remaining time: 3 minutes, 49 seconds.
## Growing trees.. Progress: 56%. Estimated remaining time: 3 minutes, 10 seconds.
## Growing trees.. Progress: 64%. Estimated remaining time: 2 minutes, 32 seconds.
## Growing trees.. Progress: 72%. Estimated remaining time: 1 minute, 58 seconds.
## Growing trees.. Progress: 80%. Estimated remaining time: 1 minute, 24 seconds.
## Growing trees.. Progress: 88%. Estimated remaining time: 48 seconds.
## Growing trees.. Progress: 97%. Estimated remaining time: 11 seconds.</code></pre>
</div>
<div id="calculate-proximity-matrices" class="section level3">
<h3>Calculate proximity matrices</h3>
<p>In this case I matches one-to-one. This is important; sometimes it makes more sense to match one-to-many for example.</p>
<p>Make sure that you record the weights of your matches so that you can weight your aggregations of the response you are trying to compare between these two groups - that is beyond the scope of this blog.</p>
<p>I take the first 1000 elements to speed up the runtime</p>
<pre class="r"><code>treatment_data &lt;- rf_data %&gt;% filter(vitality == 1) %&gt;% .[1:1000,]
control_data &lt;- rf_data %&gt;% filter(vitality == 0) %&gt;% .[1:1000,]

prox_matrix &lt;- 
    Similarity::proximityMatrixRanger(x = treatment_data %&gt;% select(-vitality),y = control_data %&gt;% select(-vitality),rf = rf_model)</code></pre>
<p>Here each row will represent a treatment response while each column will represent a controll response.</p>
<p>A 1 row example:</p>
<pre class="r"><code>prox_matrix[816,]</code></pre>
<pre><code>##    [1] 0.002 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [12] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [23] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [34] 0.000 0.000 0.000 0.002 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [45] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [56] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [67] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [78] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##   [89] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [100] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [111] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [122] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [133] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [144] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [155] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [166] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [177] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [188] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [199] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [210] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [221] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [232] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.002 0.000 0.000
##  [243] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [254] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [265] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [276] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [287] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.002
##  [298] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [309] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [320] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [331] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [342] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [353] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [364] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [375] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [386] 0.000 0.000 0.000 0.000 0.000 0.002 0.000 0.000 0.000 0.000 0.000
##  [397] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [408] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [419] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [430] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [441] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [452] 0.002 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [463] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [474] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [485] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [496] 0.000 0.000 0.000 0.000 0.000 0.000 0.002 0.000 0.000 0.000 0.000
##  [507] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [518] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [529] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [540] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [551] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [562] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [573] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [584] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [595] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [606] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [617] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [628] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [639] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [650] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [661] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [672] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [683] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [694] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [705] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [716] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [727] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [738] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [749] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [760] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.006
##  [771] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [782] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [793] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [804] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [815] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [826] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [837] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [848] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [859] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [870] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [881] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [892] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [903] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [914] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [925] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [936] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [947] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [958] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [969] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [980] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000
##  [991] 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.002</code></pre>
<pre class="r"><code># as.matrix(prox_matrix) &gt; 0
# (as.matrix(prox_matrix) &gt; 0) %&gt;% as.vector() %&gt;% which(.)</code></pre>
<p>The values in this matrix represent the proximity score of the {x,y} pair.</p>
<p>In the simple one-to-one case the argmax of each row represents the row_id match for each treatment response ID</p>
</div>
<div id="get-matches" class="section level3">
<h3>Get matches</h3>
<p>Getting the matches is simple since you can just grab the ID’s for each response:</p>
<pre class="r"><code>match_id &lt;- prox_matrix %&gt;% apply(MARGIN = 1,FUN = which.max)

matches_out &lt;- 
  tibble(
    customer_no =   MFAData %&gt;% 
      mutate(vitality = factor(vitality)) %&gt;% 
      filter(vitality==1) %&gt;% 
      pull(customer_no) %&gt;% .[1:1000], 
    match = MFAData %&gt;% 
      mutate(vitality = factor(vitality)) %&gt;% 
      filter(vitality==0) %&gt;% 
      pull(customer_no) %&gt;% .[1:1000] %&gt;% .[match_id],
      weights = 1
    )

matches_out</code></pre>
<pre><code>## # A tibble: 1,000 x 3
##    customer_no                      match                          weights
##    &lt;chr&gt;                            &lt;chr&gt;                            &lt;dbl&gt;
##  1 1bc0249a6412ef49b07fe6f62e6dc8de 12b5fc7904a4ed8e390a03143b2cc…    1.00
##  2 4e87337f366f72daa424dae11df0538c 22785dd2577be2ce28ef79febe80d…    1.00
##  3 f0b1d5879866f2c2eba77f39993d1184 ca47d49b363ef094ba80bd0b8c4e0…    1.00
##  4 20546457187cf3d52ea86538403e47cc 671792587502028b6cd4be7c4d662…    1.00
##  5 cfc5d9422f0c8f8ad796711102dbe32b 1b43914f3e2e1f22b1090eb86d69f…    1.00
##  6 516341c3e8f4543c8d465b0c514a6f92 7d4ce676f04524dadbb2f1565c871…    1.00
##  7 100d5d9191f185eeb98d6e291756954a 0a4dc6dae338c9cb08947c07581f7…    1.00
##  8 7364e0bb7f15ebfbc9e12d5b13f51a02 da0dba87d95286d836e37ca60ab1e…    1.00
##  9 764f9642ebf04622c53ebc366a68c0a7 fc8ce6292e51ac8214f544324c56d…    1.00
## 10 0634ac7160d3fd64ddf19bdcbdd401bb 2cb2cdcca9bdd55a897d897ac67f7…    1.00
## # ... with 990 more rows</code></pre>
<p>Here I just created a tibble where each customer ID has a corresponding match customer ID.</p>
<p>Special care must be taken however; if a row has only zero values it is important to handle this edge case. A conscious decision must be made to assign at random or to discard etc.</p>
<p>I assign all of them a weight of 1 since we matched one-to-one; make sure to assign the appropriate weight should you match one-to-many for example (read documentation of the <code>Similarity::proximityMatrixRanger</code> function)</p>
</div>
</div>
